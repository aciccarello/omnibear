import{_ as n}from"./assets/browser.b81c6ce4.js";import{g}from"./assets/url.03c87426.js";import{m as a,h as c,i as l,l as h,j as d,w as y}from"./assets/utils.83bc4df5.js";function f(t){return a.options.me=localStorage.getItem("domain"),a.options.tokenEndpoint=localStorage.getItem("tokenEndpoint"),a.options.micropubEndpoint=localStorage.getItem("micropubEndpoint"),a.getToken(t).then(function(e){if(!e)throw new Error("Token not found in token endpoint response. Missing expected field `access_token`");localStorage.setItem("token",e),a.options.token=e}).catch(function(e){c("Error fetching token",e),l().then(o=>{n.tabs.sendMessage(o.id,{action:"fetch-token-error",payload:{error:e}}),h()})})}function b(){return a.query("syndicate-to").then(t=>{const e=t["syndicate-to"];d("Syndication targets retreived",e),Array.isArray(e)?localStorage.setItem("syndicateTo",JSON.stringify(e)):(y("Syndication targets not in array format. Saving as empty array."),localStorage.setItem("syndicateTo",JSON.stringify([])))})}let r=null;function S(t,e){switch(t.action){case"begin-auth":w(t.payload);break;case"focus-window":E(e.tab.id,t.payload.pageEntry,t.payload.selectedEntry);break;case"select-entry":u(t.payload);break;case"clear-entry":p()}}function w(t){localStorage.setItem("domain",t.domain),localStorage.setItem("authEndpoint",t.metadata.authEndpoint),localStorage.setItem("tokenEndpoint",t.metadata.tokenEndpoint),localStorage.setItem("micropubEndpoint",t.metadata.micropub),n.tabs.create({url:t.authUrl},e=>{r=e.id})}function E(t,e,o){localStorage.setItem("pageEntry",JSON.stringify(e)),localStorage.setItem("pageTabId",t),o?u(o):p()}function u(t){localStorage.setItem("itemEntry",JSON.stringify(t))}function p(){localStorage.removeItem("itemEntry")}function k(t,e,o){if(!(t!==r||!I(e))){var m=g("code",e.url);setTimeout(()=>{i("Retrieving access token\u2026"),f(m).then(()=>(i("Fetching syndication targets\u2026"),b())).then(()=>{i("Authentication complete."),r=null,setTimeout(()=>{n.tabs.remove(o.id)},500)}).catch(s=>{c(s.message,s)})},500)}}function i(t){d(t),l().then(e=>{n.tabs.sendMessage(e.id,{action:"auth-status-update",payload:{message:t}})})}function I(t){var e="https://omnibear.com/auth/success";return t.url&&t.url.startsWith(e)}n.runtime.onMessage.addListener(S);n.tabs.onUpdated.addListener(k);n.contextMenus.create({title:"Reply to entry",contexts:["page","selection"],onclick:function(){typeof browser>"u"?window.open("index.html?type=reply","extension_popup","width=450,height=580,status=no,scrollbars=yes,resizable=no,top=80,left=2000"):browser.windows.create({url:"index.html?type=reply",width:450,height:580,type:"panel",left:2e3})}});
